<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SGF - Sistema de Gestão de Frota (Aegea v12.1 Bug Fix)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* CORES AEGEA */
            --primary: #003087; --accent: #00B0B9; --bg: #f3f6f9; --surface: #ffffff;
            --text-main: #1e293b; --text-sec: #64748b; --border: #e2e8f0;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --manutencao: #64748b;
            --shadow-card: 0 4px 6px -1px rgba(0, 48, 135, 0.1);
            --shadow-hover: 0 20px 25px -5px rgba(0, 48, 135, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); padding: 20px; color: var(--text-main); padding-bottom: 100px; }
        .container { max-width: 1280px; margin: 0 auto; display: block; animation: fadeIn 0.5s ease-out; }
        
        /* HEADER & NAV */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px 30px; background: var(--surface); border-radius: 20px; box-shadow: var(--shadow-card); border-bottom: 4px solid var(--accent); }
        .header-logo-area img { height: 55px; object-fit: contain; }
        .tabs { display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { padding: 14px 24px; background: var(--surface); border: 1px solid transparent; border-radius: 14px; font-weight: 600; color: var(--text-sec); cursor: pointer; transition: 0.2s; flex-grow: 1; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .tab-btn:hover { background: #fff; color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 8px 20px -4px rgba(0, 48, 135, 0.4); }
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border); z-index: 999; justify-content: space-around; padding: 12px 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 0.7rem; background: none; border: none; cursor: pointer; width: 100%; transition: 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        @media (max-width: 768px) { .tabs { display: none; } .bottom-nav { display: flex; } body { padding: 15px; padding-bottom: 110px; } header { padding: 20px; flex-direction: column; gap: 15px; text-align: center; } }

        /* HERO CARDS */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .hero-card { background: var(--surface); padding: 25px; border-radius: 20px; position: relative; overflow: hidden; box-shadow: var(--shadow-card); transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between; height: 140px; }
        .hero-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .hero-icon { position: absolute; right: -10px; top: -10px; font-size: 6rem; opacity: 0.08; }
        .hero-label { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; z-index: 1; }
        .hero-value { font-size: 2.8rem; font-weight: 800; line-height: 1; z-index: 1; letter-spacing: -2px; }
        .hero-rua { color: var(--warning); } .hero-disp { color: var(--success); } .hero-manut { color: var(--manutencao); }

        /* CONTROL & TABLES */
        .control-panel { background: var(--surface); padding: 30px; border-radius: 20px; box-shadow: var(--shadow-card); margin-bottom: 30px; display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 40px; border: 1px solid var(--border); }
        @media (max-width: 900px) { .control-panel { grid-template-columns: 1fr; gap: 25px; padding: 20px; } }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.75rem; color: var(--text-sec); text-transform: uppercase; }
        select, input, textarea { width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; background-color: #f8fafc; transition: all 0.2s; }
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--accent); background: #fff; box-shadow: 0 0 0 4px rgba(0, 176, 185, 0.15); }
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        button.btn-action { padding: 18px; border: none; border-radius: 14px; font-weight: 800; cursor: pointer; color: white; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s; }
        button.btn-action:active { transform: scale(0.96); }
        .btn-saida { background: linear-gradient(135deg, #f59e0b, #d97706); } .btn-entrada { background: linear-gradient(135deg, #10b981, #059669); } .btn-manutencao { background: linear-gradient(135deg, #64748b, #475569); }
        .table-wrapper { background: var(--surface); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-card); margin-top: 20px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; color: var(--text-sec); text-align: left; padding: 18px 20px; font-size: 0.75rem; text-transform: uppercase; font-weight: 800; border-bottom: 2px solid var(--border); }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: middle; font-weight: 500; }
        table tbody tr:hover { background-color: #f1f5f9; }
        .badge { padding: 6px 12px; border-radius: 30px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; display: inline-flex; align-items: center; gap: 5px; }
        .status-rua { background: #fef3c7; color: #b45309; } .status-outros { background: #e0f2fe; color: #0369a1; } .status-manut { background: #f1f5f9; color: #475569; }
        .badge-tempo { background: #e0f2f1; color: #00695c; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; border: 1px solid #b2dfdb; }

        /* === DASHBOARD V10 === */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-top: 25px; }
        .chart-card { background: white; padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-card); display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .chart-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); display: block; }
        .chart-legend-text { font-size: 0.8rem; color: var(--text-sec); font-weight: 500; margin-top: 4px; display: block; }
        
        /* Pico (Barras Verticais) */
        .peak-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; padding-top: 20px; gap: 4px; }
        .peak-col { flex: 1; background: var(--accent); border-radius: 4px 4px 0 0; position: relative; min-height: 4px; transition: height 0.5s; opacity: 0.7; }
        .peak-axis { display: flex; justify-content: space-between; font-size: 0.7rem; color: #94a3b8; margin-top: 8px; font-weight: bold; }

        /* Listas (Rankings e SLA) */
        .rank-list { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; }
        .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px dashed #f1f5f9; }
        .rank-info { font-weight: 700; color: var(--text-main); }
        .rank-val { color: var(--primary); font-weight: 800; background: #e0f7fa; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; }
        
        .sla-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fef2f2; border-left: 4px solid var(--danger); border-radius: 4px; margin-bottom: 8px; }
        .sla-text strong { display: block; color: #991b1b; font-size: 0.9rem; }
        .sla-text small { color: #b91c1c; font-size: 0.8rem; }

        /* Categoria (Barras Horizontais) */
        .cat-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.9rem; }
        .cat-name { width: 100px; font-weight: 600; color: var(--text-sec); text-align: right; margin-right: 10px; }
        .cat-bar-bg { flex: 1; background: #f1f5f9; height: 10px; border-radius: 5px; overflow: hidden; }
        .cat-bar-fill { height: 100%; background: var(--primary); border-radius: 5px; }
        .cat-val { width: 30px; text-align: right; font-weight: 800; color: var(--primary); margin-left: 10px; }
        
        /* LOGIN */
        #login-screen { background: linear-gradient(135deg, #003087 0%, #001233 100%); position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: rgba(255,255,255,0.95); padding: 50px; border-radius: 30px; width: 420px; max-width: 90%; text-align: center; box-shadow: 0 25px 60px rgba(0,0,0,0.4); backdrop-filter: blur(10px); }
        .login-btn { width: 100%; padding: 18px; margin-top: 15px; border: none; border-radius: 14px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* UTILS */
        .hidden { display: none !important; }
        .admin-only { display: none !important; }
        body.admin-mode .admin-only { display: inline-block !important; }
        body.admin-mode .nav-item.admin-only { display: flex !important; }
        body.admin-mode tr.admin-only { display: table-row !important; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.show { display: block; }
        .search-bar { position: relative; width: 300px; max-width: 100%; }
        .search-bar input { padding-left: 45px; border-radius: 30px; border-color: var(--border); }
        .search-bar i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--accent); }
        @media (max-width: 600px) { table, thead, tbody, th, td, tr { display: block; } thead tr { position: absolute; top: -9999px; left: -9999px; } tr { margin-bottom: 15px; border-radius: 16px; padding: 15px; background: white; box-shadow: var(--shadow-card); border: 1px solid var(--border); } td { border: none; border-bottom: 1px dashed var(--border); position: relative; padding-left: 45%; text-align: right; display: flex; justify-content: space-between; align-items: center; } td:before { content: attr(data-label); font-weight: 800; color: var(--text-sec); font-size: 0.75rem; text-transform: uppercase; } td:last-child { border: none; justify-content: flex-end; padding-top: 15px; } }
    /* RESOLUÇÃO PARA CELULAR: Transforma a tabela em cartões */
@media (max-width: 768px) {
    /* Esconde o cabeçalho (Placa, Condutor...) porque não cabe */
    #tabela-transito thead { display: none !important; }

    /* Transforma cada linha (TR) em um cartão branco */
    #tabela-transito tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px;
        background: #ffffff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Organiza as informações uma embaixo da outra */
    #tabela-transito td {
        display: flex;
        justify-content: space-between; /* Nome à esquerda, Dado à direita */
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Coloca o título do dado usando o 'data-label' que vamos por no JS */
    #tabela-transito td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #64748b;
        font-size: 12px;
        text-transform: uppercase;
    }

    #tabela-transito td:last-child { border-bottom: none; }

    /* Botão de BAIXAR grandão para o polegar */
    #tabela-transito td button {
        width: 100%;
        padding: 12px !important;
        margin-top: 5px;
        font-size: 16px;
    }
}
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <img src="logo.png" alt="Aegea" style="height: 70px; margin-bottom: 25px;" onerror="this.style.display='none'">
        <h1 style="color:var(--primary); font-size: 1.5rem; margin-bottom: 5px;">SGF AEGEA</h1>
        <p style="color: var(--text-sec); margin-bottom: 30px; font-size: 0.9rem;">Sistema de Gestão de Frota</p>
        <button class="login-btn" style="background: var(--accent); color: white; box-shadow: 0 8px 20px -5px rgba(0, 176, 185, 0.4);" onclick="login('motorista')"><i class="fa-solid fa-steering-wheel"></i> ACESSO MOTORISTA</button>
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <button class="login-btn" style="background: white; border: 2px solid var(--primary); color: var(--primary);" onclick="mostrarInputAdmin()"><i class="fa-solid fa-lock"></i> ÁREA ADMINISTRATIVA</button>
            <input type="password" id="admin-pass" style="margin-top: 15px; display: none;" placeholder="Senha do Admin" onkeyup="checkAdminPass(event)">
        </div>
    </div>
</div>

<input type="file" id="input-restore" class="hidden" accept=".json" onchange="processarRestauracao(this)">

<div class="container">
    <header>
        <div class="header-logo-area">
            <img src="logo.png" alt="Logo" onerror="this.style.display='none';">
            <div style="display: inline-block; vertical-align: middle; margin-left: 15px;">
                <h2 style="margin:0; font-size: 1.4rem;">SGF AEGEA</h2>
                <span class="badge" style="background:var(--accent); color:white; margin-top:5px;" id="user-badge">Visitante</span>
            </div>
        </div>
        <div style="text-align: right;">
            <h2 id="relogio" style="font-family: monospace; font-weight: 700; color: var(--primary); margin:0;">00:00</h2>
            <button onclick="window.logout()" style="margin-left: 15px; background: var(--danger); color: white; border:none; padding: 8px 12px; border-radius: 10px; cursor: pointer;"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="window.mudarAba('monitoramento')"><i class="fa-solid fa-map-location-dot"></i> Monitoramento</button>
        <button class="tab-btn admin-only" onclick="window.mudarAba('dashboard')"><i class="fa-solid fa-chart-pie"></i> Dashboard Pro</button>
        <button class="tab-btn admin-only" onclick="window.mudarAba('manutencao')"><i class="fa-solid fa-wrench"></i> Manutenção</button>
        <button class="tab-btn admin-only" onclick="window.mudarAba('historico')"><i class="fa-solid fa-clock-rotate-left"></i> Histórico</button>
        <button class="tab-btn admin-only" onclick="window.mudarAba('gestao')"><i class="fa-solid fa-gear"></i> Gestão</button>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="window.mudarAba('monitoramento')"><i class="fa-solid fa-map-location-dot"></i><span>Monitor</span></button>
        <button class="nav-item admin-only" onclick="window.mudarAba('dashboard')"><i class="fa-solid fa-chart-pie"></i><span>Dash</span></button>
        <button class="nav-item admin-only" onclick="window.mudarAba('manutencao')"><i class="fa-solid fa-wrench"></i><span>Manut</span></button>
        <button class="nav-item admin-only" onclick="window.mudarAba('historico')"><i class="fa-solid fa-clock-rotate-left"></i><span>Hist</span></button>
        <button class="nav-item admin-only" onclick="window.mudarAba('gestao')"><i class="fa-solid fa-gear"></i><span>Gestão</span></button>
    </nav>

    <div id="aba-monitoramento" class="tab-content show">
        <div class="status-grid">
            <div class="hero-card hero-rua"><i class="fa-solid fa-road hero-icon"></i><span class="hero-label">Em Trânsito</span><span id="count-rua" class="hero-value">0</span></div>
            <div class="hero-card hero-disp"><i class="fa-solid fa-square-parking hero-icon"></i><span class="hero-label">Disponível</span><span id="count-garagem" class="hero-value">0</span></div>
            <div class="hero-card hero-manut"><i class="fa-solid fa-screwdriver-wrench hero-icon"></i><span class="hero-label">Manutenção</span><span id="count-manutencao" class="hero-value">0</span></div>
        </div>

        <div class="control-panel">
            <div>
                <div class="form-group"><label>1. Selecione o Veículo</label><select id="select-placa" onchange="preencherDados()"><option value="">-- Toque para selecionar --</option></select></div>
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 2;"><label>Modelo</label><input type="text" id="input-modelo" class="readonly-field" readonly></div>
                    <div class="form-group" style="flex: 1;"><label>KM Saída</label><input type="number" id="input-km-saida" placeholder="000"></div>
                </div>
                <div class="form-group"><label>Condutor / Destino</label><input type="text" id="input-condutor" placeholder="Nome do condutor"></div>
                <div class="form-group"><label>Justificativa</label><input type="text" id="input-justificativa" placeholder="Opcional..."></div>
            </div>
            <div style="display: flex; flex-direction: column; justify-content: center;">
                <div id="status-box" style="text-align: center; margin-bottom: 20px; padding: 30px; border-radius: 20px; background: #f8fafc; border: 2px dashed var(--border);"><span style="color: var(--text-sec); font-size: 0.8rem; text-transform: uppercase; font-weight: 800; letter-spacing: 1px;">Status Atual</span><br><strong id="status-texto" style="font-size: 1.4rem; color: var(--primary);">Aguardando...</strong></div>
                <div class="actions">
                    <button class="btn-action btn-saida" onclick="window.registrarSaida('RUA')"><i class="fa-solid fa-road"></i> SAÍDA</button>
                    <button class="btn-action btn-saida" style="background: linear-gradient(135deg, var(--info), #2563eb);" onclick="window.registrarSaida('OUTROS')"><i class="fa-solid fa-share"></i> OUTROS</button>
                    <button class="btn-action btn-entrada" onclick="registrarEntrada()"><i class="fa-solid fa-check"></i> BAIXAR</button>
                    <button class="btn-action btn-manutencao admin-only" onclick="enviarParaManutencao()"><i class="fa-solid fa-screwdriver-wrench"></i> MANUT.</button>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h3 style="color: var(--primary); font-weight: 800;">VEÍCULOS NA RUA</h3>
            <div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Pesquisar..." onkeyup="filtrarTabela('tabela-transito', this.value)"></div>
        </div>

        <div class="table-wrapper">
            <table id="tabela-transito">
                <thead><tr><th>Placa</th><th>Condutor</th><th>KM</th><th>Status</th><th>Saída</th><th>Tempo</th><th>Ação</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="aba-dashboard" class="tab-content">
        <div class="dashboard-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <span class="chart-title">Horários de Pico</span>
                        <span class="chart-legend-text">Volume de saídas ao longo do dia (06h - 22h)</span>
                    </div>
                    <i class="fa-solid fa-clock" style="color: var(--accent); font-size: 1.2rem;"></i>
                </div>
                <div class="peak-chart" id="chart-peak"></div>
                <div class="peak-axis"><span>06h</span><span>12h</span><span>18h</span><span>22h</span></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <span class="chart-title">Manutenção por Categoria</span>
                        <span class="chart-legend-text">Principais motivos de parada na oficina</span>
                    </div>
                    <i class="fa-solid fa-wrench" style="color: var(--manutencao); font-size: 1.2rem;"></i>
                </div>
                <div id="chart-manutencao-cat" style="min-height: 170px;"></div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <span class="chart-title">Ranking de Rodagem</span>
                        <span class="chart-legend-text">Top 5 Veículos com mais KM acumulados</span>
                    </div>
                    <i class="fa-solid fa-gauge-high" style="color: var(--success); font-size: 1.2rem;"></i>
                </div>
                <div class="rank-list" id="list-ranking-km"></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <span class="chart-title">Alertas de SLA (Viagens > 10h)</span>
                        <span class="chart-legend-text">Últimas ocorrências de viagens longas</span>
                    </div>
                    <i class="fa-solid fa-triangle-exclamation" style="color: var(--danger); font-size: 1.2rem;"></i>
                </div>
                <div class="rank-list" id="list-sla-alerts">
                    <div style="text-align:center; color:#ccc; padding:20px;">Nenhum alerta recente</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="aba-manutencao" class="tab-content">
        <div class="control-panel" style="grid-template-columns: 1fr; gap: 10px; padding: 20px; margin-bottom: 20px;">
            <div class="search-bar" style="width:100%"><i class="fa-solid fa-filter"></i><input type="text" id="filtro-manut-texto" placeholder="Pesquisar Placa, Categoria ou Motivo (Atuais e Histórico)..." onkeyup="renderizarTabelaManutencao()"></div>
        </div>
        
        <h3 style="color: var(--primary); font-weight: 800; margin-bottom: 15px;">Em Manutenção (Atuais: <span id="count-manutencao-ativa">0</span>)</h3>
        <div class="table-wrapper" style="margin-bottom: 30px;">
            <table id="tabela-manutencao-ativa">
                <thead><tr><th>Placa</th><th>Modelo</th><th>Categoria</th><th>Motivo</th><th>Data Início</th><th>Tempo</th><th>Ação</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <h3 style="color: var(--manutencao); font-weight: 800; border-top: 1px solid var(--border); padding-top: 20px;">Histórico de Manutenção</h3>
        <div class="table-wrapper">
            <table id="tabela-manutencao-historico">
                <thead><tr><th>Placa</th><th>Categoria</th><th>Motivo</th><th>Início</th><th>Fim</th><th>Tempo Total</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="aba-historico" class="tab-content">
        <div class="control-panel" style="grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; padding: 20px;">
            <div class="search-bar" style="width:100%"><i class="fa-solid fa-filter"></i><input type="text" id="filtro-hist-texto" placeholder="Filtrar..." onkeyup="filtrarHistorico()"></div>
            <input type="date" id="filtro-data-inicio" onchange="filtrarHistorico()">
            <input type="date" id="filtro-data-fim" onchange="filtrarHistorico()">
            <button class="btn-action" style="background: var(--success); padding: 10px 20px; font-size: 0.8rem;" onclick="exportarExcel()"><i class="fa-solid fa-file-csv"></i></button>
        </div>
        <div class="table-wrapper">
            <table id="tabela-historico">
                <thead><tr><th>Data</th><th>Placa</th><th>Condutor</th><th>KM Rodados</th><th>Obs</th><th class="admin-only">Ação</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="display: flex; justify-content: center; margin-top: 20px; gap: 20px;">
            <button class="tab-btn" style="width:50px; flex-grow:0" onclick="mudarPagina(-1)"><i class="fa-solid fa-chevron-left"></i></button>
            <span id="page-info" style="font-weight: 700; color: var(--text-sec);">Página 1</span>
            <button class="tab-btn" style="width:50px; flex-grow:0" onclick="mudarPagina(1)"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>

    <div id="aba-gestao" class="tab-content">
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px;">
            <div class="chart-card">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Cadastro</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group"><input type="text" id="gestao-placa" placeholder="PLACA" style="text-transform: uppercase;"></div>
                    <div class="form-group"><input type="text" id="gestao-modelo" placeholder="MODELO"></div>
                    <div class="form-group"><input type="number" id="gestao-km-atual" placeholder="KM ATUAL"></div>
                    <div class="form-group"><input type="number" id="gestao-km-revisao" placeholder="KM REVISÃO"></div>
                </div>
                <div class="form-group" style="margin-top: 15px;"><input type="text" id="gestao-condutor" placeholder="CONDUTOR PADRÃO"></div>
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button class="btn-action" style="background: var(--success); flex: 1;" onclick="salvarVeiculo()">SALVAR <i class="fa-solid fa-floppy-disk"></i></button>
                    <button class="btn-action" style="background: var(--manutencao); width: 100px;" onclick="limparFormGestao()">NOVO</button>
                </div>
                <div class="table-wrapper" style="margin-top: 30px;">
                    <table id="tabela-gestao">
                        <thead><tr><th>Placa</th><th>Modelo</th><th>KM</th><th>Rev.</th><th>Ação</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div>
                <div class="chart-card" style="height: fit-content; margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">Backup</h3>
                    <button class="btn-action" style="background: var(--primary); width: 100%; margin-bottom: 15px;" onclick="baixarBackup()"><i class="fa-solid fa-download"></i> BAIXAR</button>
                    <button class="btn-action" style="background: var(--accent); width: 100%;" onclick="document.getElementById('input-restore').click()"><i class="fa-solid fa-upload"></i> RESTAURAR</button>
                </div>
                
                <div class="chart-card" style="height: fit-content;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;"><i class="fa-solid fa-list-check"></i> Categorias de Manutenção</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="input-nova-categoria" placeholder="Nova Categoria" style="flex: 1; padding: 10px; border-radius: 8px;">
                        <button class="btn-action" style="background: var(--accent); width: 80px; padding: 10px; border-radius: 10px;" onclick="adicionarCategoria()">ADD</button>
                    </div>
                    <ul id="lista-categorias" style="list-style: none; padding: 0; max-height: 150px; overflow-y: auto;">
                        </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
// --- 1. CONFIGURAÇÃO FIREBASE ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
const firebaseConfig = {
    apiKey: "AIzaSyAR87299J4SWl8qz9zX9_cNjJMoiXfRdDc",
    authDomain: "aegea-21b34.firebaseapp.com",
    databaseURL: "https://aegea-21b34-default-rtdb.firebaseio.com",
    projectId: "aegea-21b34",
    storageBucket: "aegea-21b34.firebasestorage.app",
    messagingSenderId: "205645361536",
    appId: "1:205645361536:web:5223c969f8441b213c1165"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
    // --- VIGIA DE LOGIN (onAuthStateChanged) ---
onAuthStateChanged(auth, (user) => {
    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app-screen');

    if (user) {
        if (loginScreen) loginScreen.style.display = 'none';
        if (appScreen) appScreen.style.display = 'block';
    } else {
        // Se deslogou, força a volta para a tela de login
        if (loginScreen) loginScreen.style.display = 'flex';
        if (appScreen) appScreen.style.display = 'none';
    }
});

    //(Variáveis de Controle) ---
window.paginaAtual = 1;
window.categoriasManutencao = ['Mecânica', 'Elétrica', 'Pneus', 'Troca de Óleo', 'Limpeza', 'Outros']; 
window.itensPorPagina = 10;
window.historicoFiltradoCache = [];

// Referências globais
const baseFrotaRef = ref(db, 'baseFrota');
const emTransitoRef = ref(db, 'emTransito');
const historicoRef = ref(db, 'historico');

// --- FUNÇÕES DE UTILIDADE PARA TEMPO E DATA ---

window.formatarHora = function(dataISO) {
    if (!dataISO) return "--:--";
    try {
        const d = new Date(dataISO);
        // Retorna apenas Hora:Minuto
        return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    } catch (e) {
        return "--:--";
    }
};

window.calcularTempo = function(ms) {
    if (!ms || ms < 0) return "0min";
    const totalMinutos = Math.floor(ms / 60000);
    const horas = Math.floor(totalMinutos / 60);
    const minutos = totalMinutos % 60;
    
    if (horas > 0) {
        return `${horas}h ${minutos}min`;
    }
    return `${minutos}min`;
};


    // --- FUNÇÕES DE RENDERIZAÇÃO ---
window.renderizarTabelaManutencao = function() {
    const tb = document.querySelector('#tabela-manutencao tbody');
    if (!tb) return;
    tb.innerHTML = '';
    
    // Filtra veículos com revisão próxima (ex: 500km de diferença) usando window.baseFrota
    const emManutencao = (window.baseFrota || []).filter(v => v.kmRevisao && (v.kmRevisao - v.kmAtual <= 500));

    if (emManutencao.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Nenhuma manutenção pendente.</td></tr>';
        return;
    }

    emManutencao.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${v.placa}</td>
            <td>${v.modelo}</td>
            <td>${v.kmAtual} / ${v.kmRevisao}</td>
            <td><span class="badge status-rua">REVISÃO PRÓXIMA</span></td>
        `;
        tb.appendChild(tr);
    });
};
window.mostrarInputAdmin = function(role) {
    const container = document.getElementById('admin-password-container');
    if (container) {
        container.style.display = (role === 'admin') ? 'block' : 'none';
    }
};
    
        window.mudarAba = function(n) {
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('show')); document.getElementById('aba-'+n).classList.add('show');
        document.querySelectorAll('.tab-btn, .nav-item').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll(`[onclick="mudarAba('${n}')"]`).forEach(x=>x.classList.add('active'));
        if(n === 'dashboard' && window.currentUserRole === 'admin') atualizarDashboard();
        if(n === 'manutencao' && window.currentUserRole === 'admin') renderizarTabelaManutencao(); 
        if(n === 'gestao' && window.currentUserRole === 'admin') limparFormGestao();
        if(n === 'historico' && window.currentUserRole === 'admin') filtrarHistorico();
        atualizarTabelas();
    }

    window.renderizarTabelaManutencao = function() {
    const tb = document.querySelector('#tabela-manutencao tbody');
    if (!tb) return;
    tb.innerHTML = '';
    
    // Filtra veículos com revisão próxima (ex: 500km de diferença)
    const emManutencao = (window.baseFrota || []).filter(v => v.kmRevisao && (v.kmRevisao - v.kmAtual <= 500));

    if (emManutencao.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" style="text-align:center">Nenhuma manutenção pendente.</td></tr>';
        return;
    }

    emManutencao.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${v.placa}</td>
            <td>${v.modelo}</td>
            <td>${v.kmAtual} / ${v.kmRevisao}</td>
            <td><span class="badge status-rua">REVISÃO PRÓXIMA</span></td>
        `;
        tb.appendChild(tr);
    });
};
// --- 2. OUVINTE TEMPO REAL ---

// Este bloco substitui o localStorage e atualiza o site sozinho
onValue(ref(db), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    // Salva os dados brutos (importante para achar a chave na hora de editar/deletar)
    window.rawBaseFrotaData = data.baseFrota;

    // Sincroniza o que vem da nuvem com as variáveis do seu código
    window.baseFrota = data.baseFrota ? Object.values(data.baseFrota) : [];
    window.emTransito = data.emTransito ? 
        Object.keys(data.emTransito).map(key => ({...data.emTransito[key], firebaseKey: key})) : [];
    window.historico = data.historico ? Object.values(data.historico) : [];
// IMPORTANTE: Toda vez que os dados mudarem, resetamos o filtro para refletir a nuvem
    window.historicoFiltradoCache = [...window.historico];
    window.historicoManutencao = [];
    // Atualiza todas as partes da tela
    window.renderizarTabelaGestao();
    window.carregarSelect();
    window.atualizarTabelas();
    window.renderizarHistorico(); // <--- Esta linha faz o histórico aparecer
});

// --- CONTINUAÇÃO DO SEU CÓDIGO (VARIÁVEIS DE ELEMENTOS) ---
    const selectPlaca = document.getElementById('select-placa');
    const inputModelo = document.getElementById('input-modelo');
    const inputCondutor = document.getElementById('input-condutor');
    const inputKmSaida = document.getElementById('input-km-saida');
    const inputJustificativa = document.getElementById('input-justificativa');
// --- COLOQUE AQUI (Substituindo as antigas) ---

window.login = function(role) {
    if(role === 'motorista') { 
        window.currentUserRole = 'motorista'; 
        window.iniciarSistema(); 
    } else { 
        const p = document.getElementById('admin-pass').value; 
        if(p === 'admin123') { 
            window.currentUserRole = 'admin'; 
            window.iniciarSistema(); 
        } else {
            Swal.fire({icon:'error', title:'Senha Incorreta', confirmButtonColor: 'var(--primary)'});
        }
    }
}

window.iniciarSistema = function() {
    document.getElementById('login-screen').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    if(window.currentUserRole === 'admin') {
        document.body.classList.add('admin-mode');
    }
    const badge = document.getElementById('user-badge');
    if(badge) badge.innerText = window.currentUserRole === 'admin' ? 'ADMIN' : 'OPERADOR';
    
    window.mudarAba('monitoramento'); 
    window.carregarSelect(); 
    window.atualizarTabelas();
}
    window.mostrarInputAdmin = function() {
    const campo = document.getElementById('admin-pass');
    if (campo) {
        campo.style.display = 'block';
        campo.focus();
    } else {
        // Se o seu ID for diferente, o console vai te avisar aqui
        console.error("ID 'admin-pass' não encontrado no HTML");
    }
};

// Adicione também esta para o "Enter" funcionar
window.checkAdminPass = function(e) {
    if (e.key === 'Enter') window.login('admin');
};
 
window.carregarSelect = function() {
    const select = document.getElementById('select-placa');
    if (!select) return;

    // Filtra apenas veículos que possuem placa para não dar erro no sort
    const frotaLimpa = (window.baseFrota || []).filter(v => v && v.placa);

    // Ordenação com trava de segurança para evitar o erro de 'localeCompare'
    frotaLimpa.sort((a, b) => a.placa.localeCompare(b.placa));

    select.innerHTML = '<option value="">-- Toque para selecionar --</option>';
    
    frotaLimpa.forEach(v => {
        const option = document.createElement('option');
        option.value = v.placa;
        option.textContent = `${v.placa} - ${v.modelo}`;
        select.appendChild(option);
    });
};
 window.preencherDados = function() {
    const placa = document.getElementById('select-placa').value;
    const veiculo = window.baseFrota.find(v => v.placa === placa);
    
    if (veiculo) {
        document.getElementById('input-modelo').value = veiculo.modelo;
        document.getElementById('input-km-saida').value = veiculo.kmAtual;
        
        // --- MOVA O BLOCO DE REVISÃO PARA CÁ (DENTRO DO IF) ---
        let statusHTML = 'Aguardando...';
        let boxColor = '#f8fafc';

        if(veiculo.kmRevisao && veiculo.kmAtual) {
            const kmRestante = veiculo.kmRevisao - veiculo.kmAtual;
            if(kmRestante <= 1000 && kmRestante > 0) statusHTML = '⚠️ REVISÃO PRÓXIMA';
            else if(kmRestante <= 0) statusHTML = '☠️ REVISÃO VENCIDA';
        }
        
        document.getElementById('status-texto').innerHTML = statusHTML;
        // -------------------------------------------------------
    }
};
window.registrarSaida = function() {
    const placa = document.getElementById('select-placa').value;
    const condutor = document.getElementById('input-condutor').value.trim();
    
    // 1. TRAVA DE SEGURANÇA: Verifica se o veículo já está em trânsito
    const jaEstaNaRua = (window.emTransito || []).some(v => v.placa === placa);

    if (jaEstaNaRua) {
        return Swal.fire({
            icon: 'warning',
            title: 'Veículo em Trânsito',
            text: `A placa ${placa} já possui uma saída ativa. É necessário dar entrada (baixa) antes de registrar uma nova saída.`,
            confirmButtonColor: '#3085d6'
        });
    }

    if (!placa || !condutor) {
        return Swal.fire('Erro', 'Selecione um veículo e informe o condutor.', 'error');
    }

    // Busca o KM direto da fonte global (window.baseFrota)
    const veiculo = (window.baseFrota || []).find(v => v.placa === placa);
    const kmParaSaida = veiculo ? parseInt(veiculo.kmAtual) : 0;

    const dadosSaida = {
        placa: placa,
        modelo: veiculo ? veiculo.modelo : "Não informado",
        condutor: condutor,
        kmSaida: kmParaSaida,
        saida: new Date().toISOString(),
        status: 'RUA'
    };

    // 2. ENVIO PARA O FIREBASE
 push(ref(db, 'emTransito'), dadosSaida).then(() => {
        Swal.fire('Sucesso', `Saída registrada para ${placa}.`, 'success');
        
        // Limpa os campos de texto (input)
        document.getElementById('input-condutor').value = '';
        document.getElementById('input-modelo').value = '';
        document.getElementById('input-km-saida').value = '';
        document.getElementById('select-placa').value = '';
        
        // Limpa o status de revisão se ele existir
        const statusTexto = document.getElementById('status-texto');
        if(statusTexto) statusTexto.innerHTML = 'Aguardando...';
    })
};
    
window.registrarEntrada = function() {
    const placa = document.getElementById('select-placa').value;
    if (!placa) return Swal.fire('Erro', 'Selecione uma placa primeiro.', 'error');

    const item = window.emTransito.find(x => x.placa === placa);
    if(!item) return Swal.fire('Erro', 'Este veículo não está em trânsito no banco de dados.', 'error');

    Swal.fire({
        title: 'KM de Chegada',
        input: 'number',
        inputLabel: `KM de Saída: ${item.kmSaida}`,
        showCancelButton: true,
        confirmButtonText: 'Dar Baixa',
        cancelButtonText: 'Cancelar'
    }).then((res) => {
        if(res.isConfirmed && res.value) {
            const kmChegada = parseInt(res.value);
            
            // 1. Criar o objeto de histórico
            const dadosFinal = {
                placa: item.placa,
                modelo: item.modelo || "Não informado",
                condutor: item.condutor || "Não informado",
                kmSaida: item.kmSaida,
                kmChegada: kmChegada,
                kmRodados: kmChegada - item.kmSaida,
                saida: item.saida,
                chegada: new Date().toISOString()
            };

            const chaveParaDeletar = item.firebaseKey;

            // 2. PRIMEIRO: Salva no Histórico
            push(ref(db, 'historico'), dadosFinal).then(() => {
                
                // 3. SEGUNDO: Atualiza o KM na Base da Frota
                // Usando a lógica de busca por chave que evita o "undefined"
                const veiculoFirebase = Object.entries(window.rawBaseFrotaData || {}).find(([key, val]) => val.placa === placa);
                
                if (veiculoFirebase) {
                    // Atualiza o KM real no Firebase
                    set(ref(db, `baseFrota/${veiculoFirebase[0]}/kmAtual`), kmChegada);
                }

                // 4. TERCEIRO: Só agora remove do Trânsito
                remove(ref(db, `emTransito/${chaveParaDeletar}`));

                Swal.fire('Sucesso', 'Baixa realizada com sucesso!', 'success');
                if(window.limparForm) window.limparForm();
                
            }).catch(error => {
                console.error("Erro na baixa:", error);
                Swal.fire('Erro Crítico', 'Não foi possível salvar o histórico: ' + error.message, 'error');
            });
        }
    });
};
 
  

    function limparForm() {
        selectPlaca.value = '';
        inputModelo.value = '';
        inputCondutor.value = '';
        inputKmSaida.value = '';
        inputJustificativa.value = '';
        inputKmSaida.readOnly = false;
        document.getElementById('status-texto').innerHTML = 'Aguardando...';
        document.getElementById('status-box').style.backgroundColor = '#f8fafc';
    }

    // FUNÇÃO ENVIAR PARA MANUTENÇÃO ATUALIZADA (Melhoria 3 e 4)
    window.enviarParaManutencao = async function() {
        const p = selectPlaca.value;
        const v = window.baseFrota.find(x => x.placa === p); 
        if(!p || !v) return Swal.fire('Selecione um veículo');
        if(emManutencao.find(x=>x.placa===p)) return Swal.fire('Já está em manutenção');

        // 1. Coletar Categoria e Motivo
        const { value: formValues } = await Swal.fire({
            title: 'Registro de Manutenção',
            html: `
                <div style="text-align:left; margin-bottom: 10px; font-weight:600;">Placa: <b>${p}</b></div>
                <select id="swal-categoria" class="swal2-input" style="padding:10px 15px;">
                    <option value="">-- Selecione a Categoria --</option>
                    ${categoriasManutencao.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>
                <input id="swal-motivo" class="swal2-input" placeholder="Motivo/Descrição (Opcional)" value="${inputJustificativa.value}">
            `,
            focusConfirm: false,
            preConfirm: () => {
                const categoria = document.getElementById('swal-categoria').value;
                const motivo = document.getElementById('swal-motivo').value;
                if (!categoria) { Swal.showValidationMessage('Selecione uma categoria'); return false; }
                return { categoria, motivo: motivo || categoria };
            }
        });

        if (formValues) {
            const { categoria, motivo } = formValues;
            
            // 2. Confirmar/Inserir KM Atual (Melhoria 4)
            const { value: kmAtualInput } = await Swal.fire({
                title: 'KM Atual do Veículo',
                html: `Confirme o KM atual para registro de entrada:<br><b>KM Anterior: ${v.kmAtual}</b>`,
                input: 'number',
                inputValue: v.kmAtual,
                showCancelButton: true,
                confirmButtonText: 'Confirmar e Enviar',
                confirmButtonColor: 'var(--manutencao)'
            });

            if (kmAtualInput !== undefined && kmAtualInput !== null) {
                const novoKm = parseInt(kmAtualInput);
                if(novoKm < v.kmAtual) return Swal.fire('Erro', 'KM inserido não pode ser menor que o KM atual registrado.', 'error');
                
                // Atualiza KM na baseFrota (Melhoria 4)
                v.kmAtual = novoKm; 

                // Se o carro estava em trânsito, finaliza a viagem
                const tIdx = emTransito.findIndex(x=>x.placa===p);
                if(tIdx !== -1) {
                    const it = emTransito[tIdx];
                    historico.unshift({...it, chegada: new Date().getTime(), kmChegada: it.kmSaida, kmRodados: 0, duracaoMs: 0});
                    emTransito.splice(tIdx, 1);
                }
                
                emManutencao.push({ placa: p, modelo: v.modelo, motivo: motivo, categoria: categoria, dataInicio: new Date().getTime(), kmEntrada: novoKm });
                
                salvarTudo();
                Swal.fire('Enviado!', `Veículo em manutenção. KM atualizado para ${novoKm}.`, 'success');
                limparForm();
            }
        }
    }

    window.retornarDaManutencao = function(p) {
        Swal.fire({title:'Finalizar manutenção?', showCancelButton:true, confirmButtonText:'Sim, Baixar', confirmButtonColor: 'var(--success)'}).then(r=>{
            if(r.isConfirmed){
                const finishedItem = emManutencao.find(x=>x.placa === p);
                if (finishedItem) {
                    historicoManutencao.unshift({...finishedItem, dataFim: new Date().getTime()});
                }
                emManutencao = emManutencao.filter(x=>x.placa !== p);
                salvarTudo();
                Swal.fire('Veículo Disponível', 'Manutenção registrada no histórico.', 'success');
            }
        });
    }

   window.atualizarTabelas = function() {
    const tbRua = document.querySelector('#tabela-transito tbody'); 
    if (!tbRua) return;
    tbRua.innerHTML = '';
    
    // CORREÇÃO: Usa window.emTransito que vem do Firebase
    const listaTransito = window.emTransito || [];

    if(listaTransito.length === 0) {
        tbRua.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#94a3b8;">Nenhum veículo na rua.</td></tr>`;
    } else {
        listaTransito.forEach(i => {
         // --- DENTRO DO SEU LOOP LISTATRANSITO.FOREACH ---
const diff = new Date() - new Date(i.saida); // Calcula o tempo de rua
const tr = document.createElement('tr');

// O tr.innerHTML que você já tem (com os data-labels para o celular)
tr.innerHTML = `
    <td data-label="Placa"><strong>${i.placa}</strong></td>
    <td data-label="Condutor">${i.condutor}</td>
    <td data-label="KM">${i.kmSaida}</td>
    <td data-label="Status"><span class="badge status-rua" style="background:#fef3c7; color:#b45309;">EM TRÂNSITO</span></td>
    <td data-label="Saída">${window.formatarHora(i.saida)}</td>
    <td data-label="Tempo"><span class="badge-tempo">${window.calcularTempo(diff)}</span></td>
    <td data-label="Ação">
        <button onclick="window.baixaRapida('${i.placa}')" class="btn-baixar-mobile">BAIXAR</button>
    </td>`;

// MANTENHA ESTA LINHA: Ela insere o item na tela
tbRua.appendChild(tr);
        });
    }
    
    // CORREÇÃO: Verifica o papel do usuário usando window
    if(window.currentUserRole === 'admin') {
        if (typeof window.renderizarTabelaManutencao === 'function') window.renderizarTabelaManutencao(); 
        if (typeof window.renderizarHistorico === 'function') window.renderizarHistorico(); 
        if (typeof window.renderizarTabelaGestao === 'function') window.renderizarTabelaGestao(); 
        if (typeof window.renderizarCategoriasGestao === 'function') window.renderizarCategoriasGestao();
    }
    
    if (typeof window.atualizarIndicadores === 'function') window.atualizarIndicadores();
}

// Crie também este atalho para a baixa rápida funcionar
window.baixaRapida = function(placa) {
    // Seta a placa no select e dispara a função de entrada
    const select = document.getElementById('select-placa');
    if(select) {
        select.value = placa;
        window.preencherDados(); // Atualiza os campos na tela
        window.registrarEntrada(); // Abre o alerta de KM de chegada
    }
};

    // FUNÇÕES DE GESTÃO DE CATEGORIAS (Melhoria 3)
    window.salvarCategorias = function() {
        localStorage.setItem('sgf_categorias_manutencao', JSON.stringify(categoriasManutencao));
        renderizarCategoriasGestao();
    }
    window.renderizarCategoriasGestao = function() {
        const lista = document.getElementById('lista-categorias');
        if (!lista) return; 
        lista.innerHTML = '';
        categoriasManutencao.forEach(cat => {
            const li = document.createElement('li');
            li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem;';
            li.innerHTML = `
                <span>${cat}</span>
                <button onclick="deletarCategoria('${cat}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fa-solid fa-trash-can"></i></button>
            `;
            lista.appendChild(li);
        });
    }
    window.adicionarCategoria = function() {
        const input = document.getElementById('input-nova-categoria');
        const novaCat = input.value.trim();
        if (novaCat && !categoriasManutencao.includes(novaCat)) {
            categoriasManutencao.push(novaCat);
            salvarCategorias();
            input.value = '';
            Swal.fire('Sucesso', 'Categoria adicionada!', 'success');
        } else if (novaCat) {
            Swal.fire('Atenção', 'Categoria já existe.', 'warning');
        }
    }
    window.deletarCategoria = function(cat) {
        if (categoriasManutencao.length <= 1) return Swal.fire('Erro', 'Deve haver pelo menos uma categoria.', 'error');
        Swal.fire({ title: `Deletar categoria ${cat}?`, showCancelButton: true, confirmButtonColor: 'var(--danger)' }).then(r => {
            if (r.isConfirmed) {
                categoriasManutencao = categoriasManutencao.filter(c => c !== cat);
                salvarCategorias();
            }
        });
    }

    // FUNÇÕES DE MANUTENÇÃO
   window.renderizarHistorico = function() {
    const tb = document.querySelector('#tabela-historico tbody');
    if (!tb) return;
    tb.innerHTML = '';

    // Pegamos a lista da nuvem e usamos o reverse() para os novos aparecerem no topo
    const lista = [...(window.historico || [])].reverse();

    lista.forEach(h => {
        const tr = document.createElement('tr');
        // Calcula a quilometragem percorrida na hora para exibir
        const kmRodados = h.kmChegada - h.kmSaida;

        tr.innerHTML = `
            <td>${h.placa}</td>
            <td>${h.condutor}</td>
            <td>${h.kmSaida} → ${h.kmChegada} <br><small>(${kmRodados} km)</small></td>
            <td>
                <span style="font-size:0.8rem;">
                    Saída: ${new Date(h.saida).toLocaleString('pt-BR')} <br>
                    Chegada: ${new Date(h.chegada).toLocaleString('pt-BR')}
                </span>
            </td>
        `;
        tb.appendChild(tr);
    });
};
    
    // FUNÇÕES DE DASHBOARD
    window.atualizarDashboard = function() {
        if(currentUserRole !== 'admin') return;
        renderizarChartPeak();
        renderizarChartManutencaoCat();
        renderizarRankingKm();
        renderizarSlaAlerts();
    }
    window.renderizarChartPeak = function() {
        const peakChart = document.getElementById('chart-peak');
        peakChart.innerHTML = '';
        const counts = {}; 
        for(let h=6; h<=22; h++) counts[h] = 0;

        historico.forEach(i => {
            const hour = new Date(i.saida).getHours();
            if(hour >= 6 && hour <= 22) counts[hour]++;
        });

        const maxCount = Math.max(...Object.values(counts));
        const range = [6, 9, 12, 15, 18, 21, 22]; // Horários para as colunas

        range.forEach(hour => {
            const count = counts[hour] || 0;
            const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
            const col = document.createElement('div');
            col.className = 'peak-col';
            col.style.height = `${height}%`;
            col.title = `${hour}h: ${count} saídas`;
            peakChart.appendChild(col);
        });
    }
 window.renderizarChartManutencaoCat = function() {
    const container = document.getElementById('chart-manutencao-cat');
    if (!container) return; // Segurança caso o elemento não exista na tela
    
    container.innerHTML = '';
    
    // --- LINHA NOVA: Proteção para não dar erro de "not defined" ---
    const dados = window.historicoManutencao || []; 
    
    const total = dados.length;
    if (total === 0) {
        container.innerHTML = `<div style="text-align:center; color:#ccc; padding:30px;">Sem histórico de manutenção.</div>`;
        return;
    }

    // --- AJUSTE: Agora usamos a variável "dados" que criamos acima ---
    const counts = dados.reduce((acc, curr) => {
        const cat = curr.categoria || 'Outros'; // Proteção caso a categoria esteja vazia
        acc[cat] = (acc[cat] || 0) + 1;
        return acc;
    }, {});

    const sortedCats = Object.entries(counts).sort(([, a], [, b]) => b - a);

    sortedCats.forEach(([cat, count]) => {
        const percent = (count / total) * 100;
        const row = document.createElement('div');
        row.className = 'cat-row';
        row.innerHTML = `
            <span class="cat-name">${cat}</span>
            <div class="cat-bar-bg">
                <div class="cat-bar-fill" style="width: ${percent.toFixed(0)}%;"></div>
            </div>
            <span class="cat-val">${count}</span>
        `;
        container.appendChild(row);
    });
};
    window.renderizarRankingKm = function() {
        const list = document.getElementById('list-ranking-km');
        list.innerHTML = '';
        
        const kmRodadosTotal = historico.reduce((acc, curr) => {
            acc[curr.placa] = (acc[curr.placa] || 0) + curr.kmRodados;
            return acc;
        }, {});

        const ranking = Object.entries(kmRodadosTotal)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

        if (ranking.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#ccc; padding:20px;">Sem dados de viagens no histórico.</div>`;
            return;
        }

        ranking.forEach(([placa, km]) => {
            const item = document.createElement('div');
            item.className = 'rank-item';
            item.innerHTML = `
                <span class="rank-info">${placa}</span>
                <span class="rank-val">${km.toLocaleString('pt-BR')} KM</span>
            `;
            list.appendChild(item);
        });
    }
    window.renderizarSlaAlerts = function() {
        const list = document.getElementById('list-sla-alerts');
        list.innerHTML = '';
        
        const longTrips = historico
            .filter(i => i.duracaoMs > 36000000)
            .sort((a, b) => b.saida - a.saida)
            .slice(0, 5); 

        if (longTrips.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#ccc; padding:20px;">Nenhum alerta recente.</div>`;
            return;
        }

        longTrips.forEach(i => {
            const item = document.createElement('div');
            item.className = 'sla-item';
            const duracao = calcularTempo(i.duracaoMs);
            item.innerHTML = `
                <i class="fa-solid fa-bell" style="color:var(--danger); font-size:1.5rem;"></i>
                <div class="sla-text">
                    <strong>${i.placa} - ${duracao}</strong>
                    <small>Saída: ${new Date(i.saida).toLocaleDateString()} | Condutor: ${i.condutor}</small>
                </div>
            `;
            list.appendChild(item);
        });
    }

window.atualizarIndicadores = function() {
    // CORREÇÃO: Usa window. para acessar os dados do Firebase
    const tRua = (window.emTransito || []).length; 
    const tMan = (window.emManutencao || []).length; 
    const tGar = (window.baseFrota || []).length - tRua - tMan;
    
    document.getElementById('count-rua').innerText = tRua;
    document.getElementById('count-manutencao').innerText = tMan;
    document.getElementById('count-garagem').innerText = tGar < 0 ? 0 : tGar;
}
    // FUNÇÕES DE HISTÓRICO
   window.filtrarHistorico = function() {
    const p = document.getElementById('filtro-hist-texto').value.toUpperCase();
    const dI = document.getElementById('filtro-data-inicio').value;
    const dF = document.getElementById('filtro-data-fim').value;
    
    // Converte datas para comparação numérica
    const inicioTs = dI ? new Date(dI).getTime() : 0;
    const fimTs = dF ? new Date(dF).getTime() + 86400000 : Infinity; 

    // CORREÇÃO: Usa window.historico e garante que a data seja comparada corretamente
    window.historicoFiltradoCache = (window.historico || []).filter(i => {
        const saidaData = new Date(i.saida).getTime(); // Converte a data salva para timestamp
        const dataOk = saidaData >= inicioTs && saidaData <= fimTs;
        
        // CORREÇÃO: Proteção caso justificativa seja nula
        const textoOk = (i.placa + i.condutor + (i.justificativa || "")).toUpperCase().includes(p);
        return dataOk && textoOk;
    });

   
    window.renderizarHistorico();
}

window.renderizarHistorico = function() {
    const tb = document.querySelector('#tabela-historico tbody'); 
    if (!tb) return;
    tb.innerHTML = '';
    
    // CORREÇÃO: Garante que as variáveis de paginação existam
    const start = ((window.paginaAtual || 1) - 1) * (window.itensPorPagina || 10);
    const end = start + (window.itensPorPagina || 10);
    
    // Define qual lista usar (filtrada ou total)
    let itens = (window.historicoFiltradoCache && window.historicoFiltradoCache.length > 0) 
                ? window.historicoFiltradoCache 
                : (window.historico || []);

    // Ordena para mostrar os mais recentes primeiro
    itens = [...itens].sort((a, b) => new Date(b.saida) - new Date(a.saida));

    const paginaItens = itens.slice(start, end);
    const totalPaginas = Math.ceil(itens.length / (window.itensPorPagina || 10));

    const pageInfo = document.getElementById('page-info');
    if (pageInfo) {
        pageInfo.innerText = `Página ${window.paginaAtual || 1} de ${totalPaginas === 0 ? 1 : totalPaginas}`;
    }

    if(paginaItens.length === 0) {
        tb.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Nenhum registro encontrado.</td></tr>`;
        return;
    }

    paginaItens.forEach(i => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="Data"><strong>${new Date(i.saida).toLocaleDateString()}</strong></td>
            <td data-label="Placa">${i.placa}</td>
            <td data-label="Condutor">${i.condutor}</td>
            <td data-label="KM Rodados">${i.kmRodados || 0} km</td>
            <td data-label="Obs">${i.justificativa || i.status || '-'}</td>
            <td data-label="Ação" class="admin-only">
                <button onclick="window.deletarHistorico('${i.placa}', '${i.saida}')" style="color:var(--danger);background:none;border:none;cursor:pointer">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        `;
        tb.appendChild(tr);
    });
}

    window.mudarPagina = function(delta) {
        const itens = historicoFiltradoCache.length > 0 ? historicoFiltradoCache : historico;
        const totalPaginas = Math.ceil(itens.length / itensPorPagina);
        const novaPagina = paginaAtual + delta;

        if (novaPagina >= 1 && novaPagina <= totalPaginas) {
            paginaAtual = novaPagina;
            renderizarHistorico();
        }
    }
    
    window.deletarHistorico = function(placa, saida) {
        Swal.fire({
            title: 'Deletar registro?',
            text: `Placa: ${placa}, Saída: ${new Date(saida).toLocaleDateString()}`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, deletar',
            confirmButtonColor: 'var(--danger)'
        }).then((result) => {
            if (result.isConfirmed) {
                // Filtra pelo item cuja placa E hora de saída coincidem
                historico = historico.filter(item => !(item.placa === placa && item.saida === saida)); 
                filtrarHistorico(); 
                salvarTudo();
                Swal.fire('Deletado!', 'O registro foi removido.', 'success');
            }
        });
    }
window.renderizarTabelaGestao = function() {
    const tb = document.querySelector('#tabela-gestao tbody'); 
    if (!tb) return;
    tb.innerHTML = '';

    // Usa window.baseFrota que é alimentada pelo Firebase
    window.baseFrota.forEach(i => {
        const tr = document.createElement('tr');
        
        let alertaRevisao = '';
        if (i.kmRevisao && i.kmAtual) {
            const kmRestante = i.kmRevisao - i.kmAtual;
            if (kmRestante <= 1000 && kmRestante > 0) {
                alertaRevisao = `<i class="fa-solid fa-triangle-exclamation" style="color:var(--warning); margin-left: 5px;" title="Revisão Próxima: ${kmRestante} km restantes"></i>`;
            } else if (kmRestante <= 0) {
                alertaRevisao = `<i class="fa-solid fa-skull-crossbones" style="color:var(--danger); margin-left: 5px;" title="REVISÃO VENCIDA!"></i>`;
            }
        }
        
        tr.innerHTML = `
            <td>${i.placa}</td>
            <td>${i.modelo}</td>
            <td>${i.kmAtual || 0} ${alertaRevisao}</td>
            <td>${i.kmRevisao || '-'}</td>
            <td>
                <button onclick="window.editarVeiculo('${i.placa}')" style="color:var(--primary); background:none;border:none;cursor:pointer;margin-right:10px;"><i class="fa-solid fa-pen-to-square"></i></button>
                <button onclick="window.deletarVeiculo('${i.placa}')" style="color:var(--danger);background:none;border:none;cursor:pointer"><i class="fa-solid fa-trash"></i></button>
            </td>
        `;
        tb.appendChild(tr);
    });
}

    // Inicia o modo de edição (Melhoria 1)
    window.editarVeiculo = function(placa) {
        const v = baseFrota.find(x => x.placa === placa);
        if (!v) return;
        
        document.getElementById('gestao-placa').value = v.placa;
        document.getElementById('gestao-modelo').value = v.modelo;
        document.getElementById('gestao-condutor').value = v.condutor || '';
        document.getElementById('gestao-km-atual').value = v.kmAtual || '';
        document.getElementById('gestao-km-revisao').value = v.kmRevisao || '';

        // Bloqueia a placa e sinaliza modo edição
        document.getElementById('gestao-placa').readOnly = true;
        document.getElementById('gestao-placa').style.backgroundColor = '#e2e8f0';
        
        document.querySelector('#aba-gestao .chart-card button.btn-action[onclick="salvarVeiculo()"]').innerHTML = 'ATUALIZAR <i class="fa-solid fa-arrows-rotate"></i>';

        Swal.fire({ icon: 'info', title: 'Modo Edição', text: 'Você está editando o veículo. Clique em ATUALIZAR para salvar.', timer: 3000, showConfirmButton: false });
    }

 window.salvarVeiculo = function() {
    const placaInput = document.getElementById('gestao-placa');
    const p = placaInput.value.trim().toUpperCase();
    if(!p) return Swal.fire('Erro', 'A placa é obrigatória.', 'error');
    
    const obj = { 
        placa: p, 
        modelo: document.getElementById('gestao-modelo').value.trim(), 
        condutor: document.getElementById('gestao-condutor').value.trim(), 
        kmAtual: parseInt(document.getElementById('gestao-km-atual').value) || 0, 
        kmRevisao: parseInt(document.getElementById('gestao-km-revisao').value) || 0 
    };
    
    const isEditing = placaInput.readOnly; 

    if(isEditing) {
        // Busca a chave única do Firebase para este veículo
        // Nota: Assumindo que sua baseFrota no Firebase usa as chaves do push()
        // Se você salvou como baseFrota/PLACA, use ref(db, 'baseFrota/' + p)
        const veiculoFirebase = Object.entries(window.rawBaseFrotaData || {}).find(([key, val]) => val.placa === p);
        
        if(veiculoFirebase) {
            set(ref(db, `baseFrota/${veiculoFirebase[0]}`), obj)
                .then(() => {
                    Swal.fire('Atualizado', '', 'success');
                    window.limparFormGestao();
                });
        }
    } else {
        // Verifica duplicidade na variável global sincronizada
        if(window.baseFrota.find(x => x.placa === p)) {
            return Swal.fire('Erro', 'Placa já cadastrada no Banco de Dados.', 'error');
        }
        
        push(ref(db, 'baseFrota'), obj).then(() => {
            Swal.fire('Criado', 'Veículo salvo na nuvem', 'success');
            window.limparFormGestao();
        });
    }
}

    window.limparFormGestao = function() { 
        document.getElementById('gestao-placa').value=""; 
        document.getElementById('gestao-modelo').value=""; 
        document.getElementById('gestao-condutor').value=""; 
        document.getElementById('gestao-km-atual').value=""; 
        document.getElementById('gestao-km-revisao').value=""; 
        
        // Reseta modo edição (Melhoria 1)
        document.getElementById('gestao-placa').readOnly = false;
        document.getElementById('gestao-placa').style.backgroundColor = '';
        document.querySelector('#aba-gestao .chart-card button.btn-action[onclick="salvarVeiculo()"]').innerHTML = 'SALVAR <i class="fa-solid fa-floppy-disk"></i>';
    }

     window.deletarVeiculo = function(p) {
    Swal.fire({
        title: `Deletar ${p}?`,
        text: "Esta ação não pode ser desfeita na nuvem.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--danger)',
        confirmButtonText: 'Sim, deletar!'
    }).then(r => {
        if(r.isConfirmed) {
            // Encontra a chave do Firebase baseada na placa
            const veiculoFirebase = Object.entries(window.rawBaseFrotaData || {}).find(([key, val]) => val.placa === p);
            
            if(veiculoFirebase) {
                remove(ref(db, `baseFrota/${veiculoFirebase[0]}`))
                    .then(() => Swal.fire('Deletado!', '', 'success'));
            } else {
                Swal.fire('Erro', 'Não foi possível localizar o ID do veículo.', 'error');
            }
        }
    });
}
    function atualizarRelogio() { document.getElementById('relogio').innerText = new Date().toLocaleTimeString(); }
    function formatarHora(ts) { return new Date(ts).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}); }
    function calcularTempo(ms) { const h=Math.floor(ms/3600000), m=Math.round((ms%3600000)/60000); return `${h}h ${m}m`; }
    function calcularTempoParado(ms) { const d=Math.floor(ms/86400000); const h=Math.floor((ms%86400000)/3600000); const m=Math.round((ms%3600000)/60000); if(d>0) return `${d}d ${h}h`; return `${h}h ${m}m`; }
    function filtrarTabela(id, txt) { document.querySelectorAll(`#${id} tbody tr`).forEach(r => r.style.display = r.innerText.toUpperCase().includes(txt.toUpperCase()) ? '' : 'none'); }
    

    
    window.baixaRapida = function(p) { selectPlaca.value=p; preencherDados(); registrarEntrada(); }

    window.baixarBackup = function() { 
        const dataToSave = {
            frota: baseFrota, 
            transito: emTransito, 
            manutencao: emManutencao, 
            historico: historico,
            manutencaoHistorico: historicoManutencao,
            categorias: categoriasManutencao
        };
        const a=document.createElement('a'); 
        a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(dataToSave)); 
        a.download="backup.json"; 
        a.click(); 
    }
    window.processarRestauracao = function(i) { 
        const r=new FileReader(); 
        r.onload=e=>{ 
            const d=JSON.parse(e.target.result); 
            if(d.frota){ 
                baseFrota=d.frota; 
                emTransito=d.transito; 
                emManutencao=d.manutencao; 
                historico=d.historico; 
                historicoManutencao=d.manutencaoHistorico || []; 
                categoriasManutencao=d.categorias || ['Mecânica', 'Elétrica', 'Pneus', 'Funilaria', 'Revisão', 'Outros'];
                salvarTudo(); 
                location.reload(); 
            }
        }; 
        r.readAsText(i.files[0]); 
    }
   window.exportarExcel = function() {
        // O caractere \ufeff ajuda o Excel a reconhecer o arquivo como UTF-8
        let csvContent = "\ufeffsep=;\n"; 
        csvContent += "Data;Placa;Condutor;KM Rodados;Tempo Viagem;Obs\n";

        // Percorre o histórico real do seu sistema
        historico.forEach(item => {
            const linha = `${item.data};${item.placa};${item.condutor};${item.km};${item.tempo};${item.obs}\n`;
            csvContent += linha;
        });

        // Especifica o tipo com charset utf-8
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement("a");
        a.href = url;
        a.download = "Historico_Frota.csv";
        document.body.appendChild(a); // Adiciona ao corpo para garantir funcionamento em todos browsers
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
    };
    // NO FINAL DO ARQUIVO:
window.logout = function() {
    // Usamos o auth que inicializamos no passo anterior
    signOut(auth).then(() => {
        // Sucesso: a tela de login aparecerá sozinha pelo onAuthStateChanged
        console.log("Sessão encerrada");
    }).catch((error) => {
        console.error("Erro ao sair:", error);
    });
};
</script>
</body>
</html>  
